<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MCQ Exam System</title>

<style>
body{font-family:Arial;background:linear-gradient(135deg,#e0f2fe,#f8fafc);margin:0}
.header{background:#0f172a;color:#fff;padding:14px;text-align:center;font-size:20px}

.center{
 max-width:1200px;margin:25px auto;background:#fff;padding:20px;
 border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.12)
}

button{
 padding:10px 18px;font-size:14px;border:none;border-radius:8px;
 cursor:pointer;margin:4px
}
.btn-main{background:#2563eb;color:#fff}
.btn-sec{background:#475569;color:#fff}
.btn-del{background:#dc2626;color:#fff}

.layout{display:grid;grid-template-columns:1fr 240px;gap:20px}

.q-card{
 background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #cbd5e1
}
.question{font-size:18px;font-weight:bold;margin-bottom:15px}

.option{
 border:1px solid #cbd5e1;padding:12px;border-radius:8px;
 margin-bottom:10px;cursor:pointer;background:#fff
}
.option:hover{background:#f1f5f9}
.option.correct{background:#bbf7d0}
.option.wrong{background:#fecaca}

.palette{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.palette div{
 padding:10px;text-align:center;border-radius:6px;
 background:#e5e7eb;font-weight:bold;cursor:pointer
}
.palette .green{background:#86efac}
.palette .red{background:#fca5a5}
.palette .grey{background:#e5e7eb}

.btn-row{display:flex;justify-content:space-between;margin-top:15px}
</style>
</head>

<body>

<div class="header">MCQ Practice ‚Äì Real Exam Mode</div>

<!-- START -->
<div class="center" id="startScreen">
 <button class="btn-main" onclick="showSaved()">üìÇ Start / Manage Tests</button>
 <button class="btn-main" onclick="showAdd()">‚ûï Add JSON Files</button>
 <button class="btn-sec" onclick="downloadAll()">üì• Download All JSON</button>
</div>

<!-- LIST -->
<div class="center" id="listScreen" style="display:none">
 <h3>Saved Tests</h3>
 <div id="savedList"></div>
 <button onclick="backStart()">‚¨Ö Back</button>
</div>

<!-- ADD -->
<div class="center" id="addScreen" style="display:none">
 <h3>Upload Multiple JSON Files</h3>
 <input type="file" accept=".json" multiple onchange="uploadMultiple(this)">
 <p>Each JSON file will be saved as a separate test.</p>
 <button onclick="backStart()">‚¨Ö Back</button>
</div>

<!-- EXAM -->
<div class="center" id="examScreen" style="display:none">
 <button class="btn-sec" onclick="exitExam()">‚¨Ö Exit Exam</button>

 <div class="layout">
  <div class="q-card">
   <div id="qBox"></div>
   <div class="btn-row">
    <button class="btn-sec" onclick="prevQ()">‚Üê Previous</button>
    <button class="btn-main" onclick="saveNext()">Save & Next ‚Üí</button>
   </div>
  </div>

  <div>
   <h4>Questions</h4>
   <div class="palette" id="palette"></div>
  </div>
 </div>
</div>

<!-- RESULT -->
<div class="center" id="resultScreen" style="display:none;text-align:center">
 <h2>Test Completed</h2>
 <p id="scoreText"></p>
 <button class="btn-main" onclick="reattempt()">üîÅ Reattempt</button>
 <button onclick="exitExam()">üìÇ Test List</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
let questions=[],originalQs=[],current=0,answers={},correct=0;

/* ---------- SHUFFLE ---------- */
function shuffleOptions(q){
 const c=q.options[q.correctIndex];
 const s=[...q.options].sort(()=>Math.random()-0.5);
 return {text:q.text,options:s,correctIndex:s.indexOf(c)};
}

/* ---------- SMART PARSE ---------- */
function smartParse(raw){
 raw=raw.replace(/'/g,'"');
 try{return extract(JSON.parse(raw),[]);}catch(e){return[];}
}
function extract(d,r=[]){
 if(Array.isArray(d))d.forEach(x=>extract(x,r));
 else if(d&&typeof d==="object"){
  const q=d.question||d.q||d.text;
  const o=d.options||d.answers||d.choices||[];
  const a=d.correctIndex??d.answer??0;
  if(q&&o.length)r.push({text:q,options:o,correctIndex:a});
  Object.values(d).forEach(v=>extract(v,r));
 }
 return r;
}

/* ---------- UPLOAD MULTIPLE ---------- */
function uploadMultiple(inp){
 const lib=JSON.parse(localStorage.getItem('mcq_lib')||'{}');

 [...inp.files].forEach(f=>{
  const r=new FileReader();
  r.onload=e=>{
   const qs=smartParse(e.target.result);
   if(qs.length){
    const name=f.name.replace('.json','');
    lib[name]=qs;
    localStorage.setItem('mcq_lib',JSON.stringify(lib));
   }
  };
  r.readAsText(f);
 });

 alert("JSON files uploaded successfully");
 backStart();
}

/* ---------- NAV ---------- */
function showSaved(){startScreen.style.display='none';listScreen.style.display='block';loadSaved();}
function showAdd(){startScreen.style.display='none';addScreen.style.display='block';}
function backStart(){
 startScreen.style.display='block';
 listScreen.style.display='none';
 addScreen.style.display='none';
 examScreen.style.display='none';
 resultScreen.style.display='none';
}

/* ---------- LOAD LIST ---------- */
function loadSaved(){
 savedList.innerHTML='';
 const lib=JSON.parse(localStorage.getItem('mcq_lib')||'{}');

 if(!Object.keys(lib).length){
  savedList.innerHTML="<p>No tests saved</p>";
  return;
 }

 Object.keys(lib).forEach(k=>{
  const d=document.createElement('div');
  d.style.marginBottom="12px";
  d.innerHTML=`
   <b>${k}</b><br>
   <button class="btn-main">‚ñ∂ Start</button>
   <button class="btn-del">‚ùå Delete</button>
  `;

  d.querySelector('.btn-main').onclick=()=>startExam(lib[k]);
  d.querySelector('.btn-del').onclick=()=>{
   if(confirm("Delete this test?")){
    delete lib[k];
    localStorage.setItem('mcq_lib',JSON.stringify(lib));
    loadSaved();
   }
  };

  savedList.appendChild(d);
 });
}

/* ---------- EXAM ---------- */
function startExam(qs){
 originalQs=qs;
 questions=qs.map(q=>shuffleOptions(q));
 current=0;answers={};correct=0;
 palette.innerHTML='';
 questions.forEach((_,i)=>{
  const p=document.createElement('div');
  p.innerText=i+1;p.className='grey';
  p.onclick=()=>jumpTo(i);
  palette.appendChild(p);
 });
 listScreen.style.display='none';
 examScreen.style.display='block';
 render();
}

function render(){
 const q=questions[current];
 let h=`<div class="question">Q${current+1}. ${q.text}</div>`;
 q.options.forEach((o,i)=>{
  h+=`<div class="option" onclick="selectOption(${i})">
        <input type="radio" name="opt" value="${i}"> ${o}
      </div>`;
 });
 qBox.innerHTML=h;

 if(answers[current]!=null){
  selectOption(answers[current]);
 }
}

/* ---------- INSTANT RESULT ---------- */
function selectOption(i){
 const opts=document.querySelectorAll('.option');
 const radios=document.querySelectorAll('input[name="opt"]');
 radios[i].checked=true;

 opts.forEach(o=>o.classList.remove('correct','wrong'));

 const ci=questions[current].correctIndex;
 if(i===ci){
  opts[i].classList.add('correct');
 }else{
  opts[i].classList.add('wrong');
  opts[ci].classList.add('correct');
 }
}

function saveNext(){
 const s=document.querySelector('input[name="opt"]:checked');
 if(!s){alert("Option select karo");return;}
 const a=Number(s.value);
 answers[current]=a;

 const p=palette.children[current];
 p.className=a===questions[current].correctIndex?'green':'red';
 if(a===questions[current].correctIndex)correct++;

 if(current<questions.length-1){current++;render();}
 else{
  examScreen.style.display='none';
  resultScreen.style.display='block';
  scoreText.innerText=`Score: ${correct}/${questions.length}`;
 }
}

function prevQ(){if(current>0){current--;render();}}
function jumpTo(i){current=i;render();}

function reattempt(){
 questions=originalQs.map(q=>shuffleOptions(q));
 current=0;answers={};correct=0;
 resultScreen.style.display='none';
 examScreen.style.display='block';
 palette.innerHTML='';
 questions.forEach((_,i)=>{
  const p=document.createElement('div');
  p.innerText=i+1;p.className='grey';
  p.onclick=()=>jumpTo(i);
  palette.appendChild(p);
 });
 render();
}

function exitExam(){
 examScreen.style.display='none';
 resultScreen.style.display='none';
 listScreen.style.display='block';
 loadSaved();
}

/* ---------- DOWNLOAD ---------- */
function downloadAll(){
 const lib=JSON.parse(localStorage.getItem('mcq_lib')||'{}');
 if(!Object.keys(lib).length){alert("No JSON saved");return;}
 const zip=new JSZip(),f=zip.folder("MCQ_JSON");
 Object.keys(lib).forEach(k=>{
  f.file(k+".json",JSON.stringify(lib[k],null,2));
 });
 zip.generateAsync({type:'blob'}).then(b=>{
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download="MCQ_JSON.zip";
  a.click();
 });
}
</script>

</body>
</html>
